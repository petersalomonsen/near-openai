const SECRET_KEY_STORAGE_KEY = 'secretKey';
Storage.privateGet(SECRET_KEY_STORAGE_KEY);

State.init({
    secretKey: null,
    airesponse: '',
    aiquestion: '',
    accountId: '',
    iframeMessage: null
});

function init_iframe() {
    const secretKey = Storage.privateGet(SECRET_KEY_STORAGE_KEY);

    State.update({
        secretKey,
        iframeMessage: secretKey ? {
            command: 'useaccount',
            secretKey: secretKey,
        } : {
            command: 'createaccount'
        }
    });
}

function ask_ai() {
    State.update({ iframeMessage: { command: 'ask_ai', aiquestion: state.aiquestion, ts: new Date().getTime() }, progress: true });
    console.log('state updated', state.iframeMessage);
}

function changeSecretKey(secretKey) {
    State.update({ secretKey });
    Storage.privateSet(SECRET_KEY_STORAGE_KEY, secretKey);
    init_iframe();
}

function handleMessage(msg) {
    switch (msg.command) {
        case 'accountcreated':
            Storage.privateSet(SECRET_KEY_STORAGE_KEY, msg.secretKey);
            State.update({ accountId: msg.accountId, secretKey: msg.secretKey });
            break;
        case 'airesponse':
            State.update({ airesponse: msg.airesponse, progress: false });
            break;
        case 'aiprogress':
            State.update({ airesponse: msg.progressmessage, progress: true });
            break;
        case 'usingaccount':
            State.update({ accountId: msg.accountId });
            break;
        case 'ready':
            console.log('ready');
            init_iframe();
            break;
    }
}

const iframe = <iframe message={state.iframeMessage} onMessage={handleMessage} src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sPgogICAgPGhlYWQ+CiAgICAgICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiPgogICAgICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDwvaGVhZD4KICAgIDxib2R5PgogICAgICAgIDxidXR0b24gaWQ9InBsYXlidXR0b24iPnBsYXk8L2J1dHRvbj4KICAgICAgICA8ZGl2IGlkPSJsb2FkZXJwcm9ncmVzcyI+PC9kaXY+CiAgICA8L2JvZHk+CiAgICA8c2NyaXB0IHR5cGU9Im1vZHVsZSI+aW1wb3J0Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vbmVhci1hcGktanNAMi4xLjMvZGlzdC9uZWFyLWFwaS1qcy5taW4uanMiO2ltcG9ydCJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL2pzLXNoYTI1NkAwLjkuMC9zcmMvc2hhMjU2Lm1pbi5qcyI7Y29uc3QgZT17YmVsbDpbNTYsMCw2OCwwLDY2LDAsNjgsMCw2MSwwLDYzLDAsNTksMCw1NiwwLDU0LDAsNjYsMCw2NCwwLDY2LDAsNTksMCw2MSwwLDU4LDAsNTQsMCw2MSwwLDczLDAsNzEsMCw3MywwLDY2LDAsNjgsMCw1NCwwLDYxLDAsNTksMCw3MSwwLDcwLDAsNzEsMCw2NiwwLDcxLDAsNjYsMCw1OSwwXSxiYXNzOlszMiwxLDAsMCwzMiwxLDAsMCwzMCwxLDMyLDAsMzIsMCwzMiwzMCwzMCwxLDAsMCwzMCwxLDAsMCwyOCwxLDMwLDAsMzAsMCwzMCwyOCwzNywxLDAsMCwzNywxLDAsMCwzNSwxLDM3LDAsMzcsMCwzNywzNSwzNSwxLDAsMCwzNSwxLDAsMCwzMiwxLDM1LDAsMzUsMCwzNSwzMl0sa2ljazpbMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsNTAsMTIwLDAsMTAwLDAsMTIwLDAsMCwwXSxwYWQxOls2MywxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2MSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2NCwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2MywxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMV0scGFkMjpbNjgsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjYsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjgsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjYsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDFdLHBhZDM6WzcxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDcwLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDczLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDcxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxXSxsZWFkOlswLDAsNjMsMCw2OCwxLDEsMCw3MCwxLDcxLDEsMCwwLDAsMCwwLDAsNjEsMCw2NiwxLDEsMCw2OCwxLDcwLDEsMCwwLDAsMCwwLDAsNjgsMCw3MywxLDEsMCw3NSwxLDc2LDEsMCwwLDAsMCw3NSwxLDAsMCw3NSwxLDEsMCw3MywxLDc1LDEsNzEsMSw2NiwxXSxzbmFyZTpbMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDgwLDAsMTAwLDAsMCw1MF0saGloYXQ6WzMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDAsMzAsMCwzMCwwLDMwLDAsNjAsMCwzMCwwLDMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDAsMzAsMCwzMCwwLDMwLDAsNjAsMCwzMCwwLDMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDQwLDYwLDMwXX0sbj0ibWFpbm5ldCIsYT1uZXcgbmVhckFwaS5rZXlTdG9yZXMuSW5NZW1vcnlLZXlTdG9yZTtsZXQgdDtjb25zdCByPXtrZXlTdG9yZTphLG5ldHdvcmtJZDpuLG5vZGVVcmw6YGh0dHBzOi8vcnBjLiR7bn0ubmVhci5vcmdgLHdhbGxldFVybDpgaHR0cHM6Ly93YWxsZXQuJHtufS5uZWFyLm9yZ2AsaGVscGVyVXJsOmBodHRwczovL2hlbHBlci4ke259Lm5lYXIub3JnYCxleHBsb3JlclVybDpgaHR0cHM6Ly9leHBsb3Jlci4ke259Lm5lYXIub3JnYH07YXN5bmMgZnVuY3Rpb24gcyhlKXtjb25zdCBzPW5lYXJBcGkudXRpbHMuS2V5UGFpci5mcm9tU3RyaW5nKGUpLG89QnVmZmVyLmZyb20ocy5wdWJsaWNLZXkuZGF0YSkudG9TdHJpbmcoImhleCIpO2F3YWl0IGEuc2V0S2V5KG4sbyxzKTtjb25zdCBpPWF3YWl0IG5lYXJBcGkuY29ubmVjdChyKTtyZXR1cm4gdD1hd2FpdCBpLmFjY291bnQobyksb31hc3luYyBmdW5jdGlvbiBvKGUpe3RyeXt3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXByb2dyZXNzIixwcm9ncmVzc21lc3NhZ2U6ImNyZWF0aW5nIHJlcXVlc3QifSxnbG9iYWxUaGlzLnBhcmVudE9yaWdpbik7Y29uc3Qgbj1hd2FpdCBhc3luYyBmdW5jdGlvbihlKXtjb25zdCBuPXQuYWNjb3VudElkLGE9SlNPTi5zdHJpbmdpZnkoZSkscj1zaGEyNTYoYSkscz1hd2FpdCB0LmNvbm5lY3Rpb24uc2lnbmVyLmdldFB1YmxpY0tleSh0LmFjY291bnRJZCx0LmNvbm5lY3Rpb24ubmV0d29ya0lkKSxvPShhd2FpdCB0LmZpbmRBY2Nlc3NLZXkoKSkuYWNjZXNzS2V5LGk9KytvLm5vbmNlLGM9bmVhckFwaS51dGlscy5zZXJpYWxpemUuYmFzZV9kZWNvZGUoby5ibG9ja19oYXNoKSxsPW5lYXJBcGkudHJhbnNhY3Rpb25zLmNyZWF0ZVRyYW5zYWN0aW9uKHQuYWNjb3VudElkLHMsImpzaW5ydXN0Lm5lYXIiLGksW25lYXJBcGkudHJhbnNhY3Rpb25zLmZ1bmN0aW9uQ2FsbCgiYXNrX2FpIix7bWVzc2FnZV9oYXNoOnJ9LCIzMDAwMDAwMDAwMDAwMCIsNTAwMDAwMDAwMDAwMDAwMDAwMDAwMG4pXSxjKSxbZCxwXT1hd2FpdCBuZWFyQXBpLnRyYW5zYWN0aW9ucy5zaWduVHJhbnNhY3Rpb24obCx0LmNvbm5lY3Rpb24uc2lnbmVyLHQuYWNjb3VudElkLHQuY29ubmVjdGlvbi5uZXR3b3JrSWQpO3JldHVybiBKU09OLnN0cmluZ2lmeSh7c2lnbmVkX3RyYW5zYWN0aW9uOkJ1ZmZlci5mcm9tKHAuZW5jb2RlKCkpLnRvU3RyaW5nKCJiYXNlNjQiKSx0cmFuc2FjdGlvbl9oYXNoOm5lYXJBcGkudXRpbHMuc2VyaWFsaXplLmJhc2VfZW5jb2RlKGQpLHNlbmRlcl9hY2NvdW50X2lkOm4sbWVzc2FnZXM6ZX0pfShlKTt3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXByb2dyZXNzIixwcm9ncmVzc21lc3NhZ2U6InNlbmRpbmcgcmVxdWVzdCJ9LGdsb2JhbFRoaXMucGFyZW50T3JpZ2luKTtjb25zdCBhPWF3YWl0IGZldGNoKCJodHRwczovL25lYXItb3BlbmFpLWdpdC1ib3N3aWRnZXQtZ3Jvb3ZlbWFrZXItcGV0ZXJzYWxvbW9uc2VuLnZlcmNlbC5hcHAvYXBpL29wZW5haXN0cmVhbSIse21ldGhvZDoiUE9TVCIsYm9keTpufSkscj1hLmJvZHkuZ2V0UmVhZGVyKCkscz1bXTtmb3IoOzspe2NvbnN0e2RvbmU6ZSx2YWx1ZTpufT1hd2FpdCByLnJlYWQoKTtpZihlKWJyZWFrO2NvbnN0IGE9KG5ldyBUZXh0RGVjb2RlcikuZGVjb2RlKG4pO3MucHVzaChhKSx3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXByb2dyZXNzIixwcm9ncmVzc21lc3NhZ2U6YX0sZ2xvYmFsVGhpcy5wYXJlbnRPcmlnaW4pfXJldHVybiBzLmpvaW4oIiIpfWNhdGNoKGUpe3JldHVybiBjb25zb2xlLmxvZyhlLm1lc3NhZ2UpLGBVbmZvcnR1bmF0ZWx5LCB0aGVyZSB3YXMgYW4gZXJyb3I6XG5cblxgXGBcYFxuJHtlLm1lc3NhZ2V9XG5cYFxgXGBcbmB9fWFzeW5jIGZ1bmN0aW9uIGkoZSl7Y29uc3Qgbj1uZXcgbmVhckFwaS5Db250cmFjdCh0LCJ3ZWJhc3NlbWJseW11c2ljLm5lYXIiLHt2aWV3TWV0aG9kczpbIndlYjRfZ2V0Il19KSxhPWF3YWl0IG4ud2ViNF9nZXQoe3JlcXVlc3Q6e3BhdGg6Ii9tdXNpY3dhc21zL2dyb292ZWlzaW50aGVjb2RlLndhc20ifX0pLHI9YXdhaXQgZmV0Y2goYGRhdGE6YXBwbGljYXRpb24vd2FzbTtiYXNlNjQsJHthLmJvZHl9YCkudGhlbigoZT0+ZS5hcnJheUJ1ZmZlcigpKSkscz1uZXcgV29ya2VyKFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoWygoKT0+e2NvbnN0IGU9ZnVuY3Rpb24oKXtvbm1lc3NhZ2U9YXN5bmMgZT0+e2lmKGUuZGF0YS53YXNtKXtjb25zdCBuPWUuZGF0YS5zYW1wbGVyYXRlLGE9V2ViQXNzZW1ibHkuaW5zdGFudGlhdGUoZS5kYXRhLndhc20se2Vudmlyb25tZW50OntTQU1QTEVSQVRFOm59fSksdD0oYXdhaXQgYSkuaW5zdGFuY2UuZXhwb3J0cyxyPXQuYWxsb2NhdGVQYXR0ZXJucyhlLmRhdGEucGF0dGVybnMubGVuZ3RoLzE2KTtuZXcgVWludDhBcnJheSh0Lm1lbW9yeS5idWZmZXIscixlLmRhdGEucGF0dGVybnMubGVuZ3RoKS5zZXQoZS5kYXRhLnBhdHRlcm5zKTtjb25zdCBzPWUuZGF0YS5wYXR0ZXJuTGVuZ3RoLzE2LG89dC5hbGxvY2F0ZUluc3RydW1lbnRQYXR0ZXJuTGlzdChzLGUuZGF0YS5udW1JbnN0cnVtZW50cyksaT1uZXcgVWludDhBcnJheSh0Lm1lbW9yeS5idWZmZXIsbyxlLmRhdGEubnVtSW5zdHJ1bWVudHMqcyk7Zm9yKGxldCBlPTA7ZTxpLmxlbmd0aDtlKyspaVtlXT1lO2NvbnNvbGUubG9nKGkpLHQuc2V0QlBNKGUuZGF0YS5icG0pO2NvbnN0IGM9MTI4LGw9ZS5kYXRhLnNvbmdkdXJhdGlvbipuLzFlMyxkPXQuYWxsb2NhdGVTYW1wbGVCdWZmZXI/dC5hbGxvY2F0ZVNhbXBsZUJ1ZmZlcihjKTp0LnNhbXBsZWJ1ZmZlcixwPW5ldyBGbG9hdDMyQXJyYXkodC5tZW1vcnkuYnVmZmVyLGQsYyksdT1uZXcgRmxvYXQzMkFycmF5KHQubWVtb3J5LmJ1ZmZlcixkKzQqYyxjKTtsZXQgZz0wO2NvbnN0IGY9bmV3IEFycmF5QnVmZmVyKDQqbCksbT1uZXcgRGF0YVZpZXcoZiksaD1uZXcgQXJyYXlCdWZmZXIoNCpsKSx3PW5ldyBEYXRhVmlldyhoKSxiPTE9PT1uZXcgVWludDhBcnJheShuZXcgVWludDE2QXJyYXkoWzFdKS5idWZmZXIpWzBdO2Zvcig7ZzxsOyl7bnVsbCE9dC5wbGF5RXZlbnRzQW5kRmlsbFNhbXBsZUJ1ZmZlcj90LnBsYXlFdmVudHNBbmRGaWxsU2FtcGxlQnVmZmVyKCk6dC5maWxsU2FtcGxlQnVmZmVyKCk7Zm9yKGxldCBlPTA7ZTxjJiZnPGw7ZSsrKW0uc2V0RmxvYXQzMig0KmcscFtlXSxiKSx3LnNldEZsb2F0MzIoNCpnLHVbZV0sYiksZysrO3Bvc3RNZXNzYWdlKHtwcm9ncmVzczpnL2x9KX1wb3N0TWVzc2FnZSh7bGVmdGJ1ZmZlcjpmLHJpZ2h0YnVmZmVyOmh9LFtmLGhdKX19fS50b1N0cmluZygpO3JldHVybiBlLnN1YnN0cmluZyhlLmluZGV4T2YoInsiKSsxLGUubGFzdEluZGV4T2YoIn0iKSl9KSgpXSx7dHlwZToidGV4dC9qYXZhc2NyaXB0In0pKSksbz00NDEwMCxpPVsiYmVsbCIsImJhc3MiLCJwYWQxIiwicGFkMiIsInBhZDMiLCJraWNrIiwic25hcmUiLCJsZWFkIiwiaGloYXQiXSxjPW5ldyBBcnJheSg2NCppLmxlbmd0aCk7Yy5maWxsKDApLGkuZm9yRWFjaCgoKG4sYSk9PntlW25dJiZlW25dLmZvckVhY2goKChlLG4pPT5jWzY0KmErbl09ZSkpfSkpO2NvbnN0e2xlZnRidWZmZXI6bCxyaWdodGJ1ZmZlcjpkfT1hd2FpdCBuZXcgUHJvbWlzZSgoYXN5bmMgZT0+e3MucG9zdE1lc3NhZ2Uoe3dhc206cixzYW1wbGVyYXRlOm8sc29uZ2R1cmF0aW9uOjhlMyxicG06MTIwLHBhdHRlcm5MZW5ndGg6NjQscGF0dGVybnM6YyxudW1JbnN0cnVtZW50czppLmxlbmd0aH0pLHMub25tZXNzYWdlPW49PntuLmRhdGEubGVmdGJ1ZmZlcj9lKG4uZGF0YSk6ZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2xvYWRlcnByb2dyZXNzIikuaW5uZXJIVE1MPSgxMDAqbi5kYXRhLnByb2dyZXNzKS50b0ZpeGVkKDIpKyIlIn19KSk7bGV0IHA7ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBsYXlidXR0b24iKS5vbmNsaWNrPSgpPT57aWYocClyZXR1cm4gcC5jbG9zZSgpLHZvaWQocD1udWxsKTtwPW5ldyBBdWRpb0NvbnRleHQ7Y29uc3QgZT1wLmNyZWF0ZUJ1ZmZlcigyLDM1MjgwMCxvKTtlLmdldENoYW5uZWxEYXRhKDApLnNldChuZXcgRmxvYXQzMkFycmF5KGwpKSxlLmdldENoYW5uZWxEYXRhKDEpLnNldChuZXcgRmxvYXQzMkFycmF5KGQpKTtjb25zdCBuPXAuY3JlYXRlQnVmZmVyU291cmNlKCk7bi5idWZmZXI9ZSxuLmNvbm5lY3QocC5kZXN0aW5hdGlvbiksbi5sb29wPSEwLG4uc3RhcnQoMCl9fXdpbmRvdy5vbm1lc3NhZ2U9YXN5bmMgYz0+e3N3aXRjaChnbG9iYWxUaGlzLnBhcmVudE9yaWdpbj1jLm9yaWdpbixjb25zb2xlLmxvZygiaWZyYW1lIGdvdCBtZXNzYWdlIixjLmRhdGEpLGMuZGF0YS5jb21tYW5kKXtjYXNlImNyZWF0ZWFjY291bnQiOmNvbnN0e3NlY3JldEtleTpsLGFjY291bnRJZDpkfT1hd2FpdCBhc3luYyBmdW5jdGlvbigpe2NvbnN0IGU9bmVhckFwaS51dGlscy5LZXlQYWlyRWQyNTUxOS5mcm9tUmFuZG9tKCkscz1CdWZmZXIuZnJvbShlLnB1YmxpY0tleS5kYXRhKS50b1N0cmluZygiaGV4Iik7YXdhaXQgYS5zZXRLZXkobixzLGUpO2NvbnN0IG89YXdhaXQgbmVhckFwaS5jb25uZWN0KHIpO3JldHVybiB0PWF3YWl0IG8uYWNjb3VudChzKSx7c2VjcmV0S2V5OmUuc2VjcmV0S2V5LGFjY291bnRJZDpzfX0oKTt3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhY2NvdW50Y3JlYXRlZCIsc2VjcmV0S2V5OmwsYWNjb3VudElkOmR9LGdsb2JhbFRoaXMucGFyZW50T3JpZ2luKTticmVhaztjYXNlInVzZWFjY291bnQiOndpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2Uoe2NvbW1hbmQ6InVzaW5nYWNjb3VudCIsYWNjb3VudElkOmF3YWl0IHMoYy5kYXRhLnNlY3JldEtleSl9LGdsb2JhbFRoaXMucGFyZW50T3JpZ2luKSxpKGUpO2JyZWFrO2Nhc2UiYXNrX2FpIjpjb25zdCBwPWF3YWl0IG8oW3tyb2xlOiJ1c2VyIixjb250ZW50OiJIZXJlJ3MgYSBkZXNjcmlwdGlvbiBvZiBhIEphdmFTY3JpcHQgb2JqZWN0IGNvbnRhaW5pbmcgYSBtdXNpY2FsIHBhdHRlcm4gd2l0aCB0aGUgZm9sbG93aW5nIGluc3RydW1lbnRzIGFuZCBzcGVjaWZpY2F0aW9uczpcbmJlbGw6IGFuIGFycmF5IG9mIE1JREkgbm90ZSBudW1iZXJzIHJlcHJlc2VudGluZyBhIG1lbG9keSwgMCBmb3Igc2lsZW5jZSwgMSBmb3IgaG9sZGluZyBhIG5vdGVcbmxlYWQ6IGFuIGFycmF5IG9mIE1JREkgbm90ZSBudW1iZXJzIHJlcHJlc2VudGluZyBhIG1lbG9keSwgMCBmb3Igc2lsZW5jZSwgMSBmb3IgaG9sZGluZyBhIG5vdGVcbmJhc3M6IGFuIGFycmF5IG9mIE1JREkgbm90ZSBudW1iZXJzIHJlcHJlc2VudGluZyBhIGJhc2VsaW5lLCAwIGZvciBzaWxlbmNlLCAxIGZvciBob2xkaW5nIGEgbm90ZVxucGFkMTogYW4gYXJyYXkgb2YgTUlESSBub3RlIG51bWJlcnMgcmVwcmVzZW50aW5nIHRoZSBib3R0b20gbm90ZSBpbiBhIGJhY2tncm91bmQgcGFkIGluc3RydW1lbnQgY2hvcmQsIDAgZm9yIHNpbGVuY2UsIDEgZm9yIGhvbGRpbmcgYSBub3RlXG5wYWQyOiBhbiBhcnJheSBvZiBNSURJIG5vdGUgbnVtYmVycyByZXByZXNlbnRpbmcgdGhlIG1pZGRsZSBub3RlIGluIGEgYmFja2dyb3VuZCBwYWQgaW5zdHJ1bWVudCBjaG9yZCwgMCBmb3Igc2lsZW5jZSwgMSBmb3IgaG9sZGluZyBhIG5vdGVcbnBhZDM6IGFuIGFycmF5IG9mIE1JREkgbm90ZSBudW1iZXJzIHJlcHJlc2VudGluZyB0aGUgdG9wIG5vdGUgaW4gYSBiYWNrZ3JvdW5kIHBhZCBpbnN0cnVtZW50IGNob3JkLCAwIGZvciBzaWxlbmNlLCAxIGZvciBob2xkaW5nIGEgbm90ZVxua2ljazogYW4gYXJyYXkgb2YgaW50ZWdlcnMgcmVwcmVzZW50aW5nIHZlbG9jaXRpZXMgZm9yIGEgYmFzZSBkcnVtIHNvdW5kXG5zbmFyZTogYW4gYXJyYXkgb2YgaW50ZWdlcnMgcmVwcmVzZW50aW5nIHZlbG9jaXRpZXMgZm9yIGEgc25hcmUgZHJ1bSBzb3VuZFxuaGloYXQ6IGFuIGFycmF5IG9mIGludGVnZXJzIHJlcHJlc2VudGluZyB2ZWxvY2l0aWVzIGZvciBhIGhpaGF0IHNvdW5kXG5cbmJlIGF3YXJlIG9mIHRoZSB2YWx1ZSAxIHdoaWNoIGlzIHVzZWQgZm9yIGhvbGRpbmcgYSBub3RlIHRvIGxhc3QgbG9uZ2VyIHRoYW4ganVzdCBvbmUgdGljay5cblxuVGhlIGxlbmd0aCBvZiBlYWNoIGFycmF5IHNob3VsZCBiZSBtYXhpbXVtIDY0LCBhbmQgY29ycmVzcG9uZHMgdG8gMTYgYmVhdHMuXG5cbkluIHRoZSBuZXh0IG1lc3NhZ2UgaXMgYW4gZXhhbXBsZSBvZiBzdWNoIGEgamF2YXNjcmlwdCBvYmplY3QsIHRoYXQgcmVwcmVzZW50IGEgbWVsb2R5IHdpdGggdGhlIGxlYWQsIHNvbWUgYmFja2dyb3VuZCBhY2NvbXBhbnkgbWVsb2R5IHdpdGggdGhlIGJlbGwsXG5iYWNrZ3JvdW5kIGNob3JkcyB3aXRoIHRoZSBwYWRzLCBhbmQgYSBkcnVtYmVhdCB3aXRoIGtpY2ssIHNuYXJlIGFuZCBoaWhhdFxuIn0se3JvbGU6InVzZXIiLGNvbnRlbnQ6SlNPTi5zdHJpbmdpZnkoZSl9LHtyb2xlOiJ1c2VyIixjb250ZW50OiJJbiB0aGUgbmV4dCBtZXNzYWdlIGlzIGEgZGVzY3JpcHRpb24gb2YgdGhlIG11c2ljIHRoYXQgc2hvdWxkIGJlIGNyZWF0ZWQuIFRoZSByZXN1bHRpbmcgb2JqZWN0IHNob3VsZCBiZSBlbmNvZGVkIGFzIGEgSlNPTiBzdHJpbmcuIEFuIGV4YW1wbGUgaXMgaW4gdGhlIG5leHQgbWVzc2FnZS4ifSx7cm9sZToidXNlciIsY29udGVudDpjLmRhdGEuYWlxdWVzdGlvbn1dKTtsZXQgdTt0cnl7aShKU09OLnBhcnNlKHApKX1jYXRjaChlKXt1PWBFcnJvcjogJHtlLm1lc3NhZ2V9XG4gICAgICAgICAgICAgICAgXG5IZXJlJ3MgdGhlIHJlc3BvbnNlOlxuXG4ke3B9XG4gICAgICAgICAgICAgICAgYH13aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXJlc3BvbnNlIixhaXJlc3BvbnNlOnAsZXJyb3I6dX0sZ2xvYmFsVGhpcy5wYXJlbnRPcmlnaW4pfX0sd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSh7Y29tbWFuZDoicmVhZHkifSwiKiIpOwo8L3NjcmlwdD4KPC9odG1sPg==" style={{ width: '400px', height: '200px', border: 'none' }}></iframe>;

const progressIndicator = state.progress ? <Progress.Root>
    <Progress.Indicator state="indeterminate" />
</Progress.Root> : <button onClick={ask_ai}>Ask ChatGPT</button>;

const responseArea = <div style={{ marginTop: '20px', padding: '20px', backgroundColor: '#f5f5f5' }}>
    <Markdown text={state.airesponse} />
</div>;

const secretKeyToggle = state.showSecretKey ? <>
    <button onClick={() => State.update({ showSecretKey: false })}>Hide</button>
    <input type="text" value={state.secretKey} onChange={e => changeSecretKey(e.target.value)}></input>
</> :
    <button onClick={() => State.update({ showSecretKey: true })}>Show</button>

return <>
    <p><b>NOTE:</b> Each request costs about 0.005 NEAR. Make sure the spending account below is funded, and you can also get full access to
        that account by using the secret key. Only you have the key to this account, so don't loose it.</p>

    <textarea style={{ width: '100%' }} onChange={e => State.update({ aiquestion: e.target.value })} value={state.aiquestion}></textarea>
    {progressIndicator}
    {responseArea}

    {iframe}

    
    <p><br /></p>

    <p></p>
    <p>Spending account ID: <pre>{state.accountId}</pre></p>
    <p>Spending account secret key: {secretKeyToggle}</p>
</>;