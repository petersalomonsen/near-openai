const SECRET_KEY_STORAGE_KEY = 'secretKey';
Storage.privateGet(SECRET_KEY_STORAGE_KEY);

State.init({
    secretKey: null,
    airesponse: '',
    aiquestion: '',
    accountId: '',
    iframeMessage: null
});

function init_iframe() {
    const secretKey = Storage.privateGet(SECRET_KEY_STORAGE_KEY);

    State.update({
        secretKey,
        iframeMessage: secretKey ? {
            command: 'useaccount',
            secretKey: secretKey,
        } : {
            command: 'createaccount'
        }
    });
}

function ask_ai() {
    State.update({ iframeMessage: { command: 'ask_ai', aiquestion: state.aiquestion, ts: new Date().getTime() }, progress: true });
    console.log('state updated', state.iframeMessage);
}

function changeSecretKey(secretKey) {
    State.update({ secretKey });
    Storage.privateSet(SECRET_KEY_STORAGE_KEY, secretKey);
    init_iframe();
}

function handleMessage(msg) {
    switch (msg.command) {
        case 'accountcreated':
            Storage.privateSet(SECRET_KEY_STORAGE_KEY, msg.secretKey);
            State.update({ accountId: msg.accountId, secretKey: msg.secretKey });
            break;
        case 'airesponse':
            State.update({ airesponse: msg.airesponse, progress: false });
            break;
        case 'usingaccount':
            State.update({ accountId: msg.accountId });
            break;
        case 'ready':
            console.log('ready');
            init_iframe();
            break;
    }
}

const iframe = <iframe message={state.iframeMessage} onMessage={handleMessage} src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sPgogICAgPGhlYWQ+CiAgICAgICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiPgogICAgICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDwvaGVhZD4KICAgIDxib2R5PgogICAgICAgIDxidXR0b24gaWQ9InBsYXlidXR0b24iPnBsYXk8L2J1dHRvbj4KICAgICAgICA8ZGl2IGlkPSJsb2FkZXJwcm9ncmVzcyI+PC9kaXY+CiAgICA8L2JvZHk+CiAgICA8c2NyaXB0IHR5cGU9Im1vZHVsZSI+aW1wb3J0Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vbmVhci1hcGktanNAMi4xLjMvZGlzdC9uZWFyLWFwaS1qcy5taW4uanMiO2ltcG9ydCJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL2pzLXNoYTI1NkAwLjkuMC9zcmMvc2hhMjU2Lm1pbi5qcyI7Y29uc3QgZT17YmVsbDpbNTYsMCw2OCwwLDY2LDAsNjgsMCw2MSwwLDYzLDAsNTksMCw1NiwwLDU0LDAsNjYsMCw2NCwwLDY2LDAsNTksMCw2MSwwLDU4LDAsNTQsMCw2MSwwLDczLDAsNzEsMCw3MywwLDY2LDAsNjgsMCw1NCwwLDYxLDAsNTksMCw3MSwwLDcwLDAsNzEsMCw2NiwwLDcxLDAsNjYsMCw1OSwwXSxiYXNzOlszMiwxLDAsMCwzMiwxLDAsMCwzMCwxLDMyLDAsMzIsMCwzMiwzMCwzMCwxLDAsMCwzMCwxLDAsMCwyOCwxLDMwLDAsMzAsMCwzMCwyOCwzNywxLDAsMCwzNywxLDAsMCwzNSwxLDM3LDAsMzcsMCwzNywzNSwzNSwxLDAsMCwzNSwxLDAsMCwzMiwxLDM1LDAsMzUsMCwzNSwzMl0sa2ljazpbMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsNTAsMTIwLDAsMTAwLDAsMTIwLDAsMCwwXSxwYWQxOls2MywxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2MSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2NCwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2MywxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMV0scGFkMjpbNjgsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjYsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjgsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjYsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDFdLHBhZDM6WzcxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDcwLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDczLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDcxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxXSxsZWFkOlswLDAsNjMsMCw2OCwxLDEsMCw3MCwxLDcxLDEsMCwwLDAsMCwwLDAsNjEsMCw2NiwxLDEsMCw2OCwxLDcwLDEsMCwwLDAsMCwwLDAsNjgsMCw3MywxLDEsMCw3NSwxLDc2LDEsMCwwLDAsMCw3NSwxLDAsMCw3NSwxLDEsMCw3MywxLDc1LDEsNzEsMSw2NiwxXSxzbmFyZTpbMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDgwLDAsMTAwLDAsMCw1MF0saGloYXQ6WzMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDAsMzAsMCwzMCwwLDMwLDAsNjAsMCwzMCwwLDMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDAsMzAsMCwzMCwwLDMwLDAsNjAsMCwzMCwwLDMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDQwLDYwLDMwXX0sbj0ibWFpbm5ldCIsYT1uZXcgbmVhckFwaS5rZXlTdG9yZXMuSW5NZW1vcnlLZXlTdG9yZTtsZXQgdDtjb25zdCByPXtrZXlTdG9yZTphLG5ldHdvcmtJZDpuLG5vZGVVcmw6YGh0dHBzOi8vcnBjLiR7bn0ubmVhci5vcmdgLHdhbGxldFVybDpgaHR0cHM6Ly93YWxsZXQuJHtufS5uZWFyLm9yZ2AsaGVscGVyVXJsOmBodHRwczovL2hlbHBlci4ke259Lm5lYXIub3JnYCxleHBsb3JlclVybDpgaHR0cHM6Ly9leHBsb3Jlci4ke259Lm5lYXIub3JnYH07YXN5bmMgZnVuY3Rpb24gcyhlKXtjb25zdCBzPW5lYXJBcGkudXRpbHMuS2V5UGFpci5mcm9tU3RyaW5nKGUpLG89QnVmZmVyLmZyb20ocy5wdWJsaWNLZXkuZGF0YSkudG9TdHJpbmcoImhleCIpO2F3YWl0IGEuc2V0S2V5KG4sbyxzKTtjb25zdCBpPWF3YWl0IG5lYXJBcGkuY29ubmVjdChyKTtyZXR1cm4gdD1hd2FpdCBpLmFjY291bnQobyksb31hc3luYyBmdW5jdGlvbiBvKGUpe3RyeXtjb25zdCBuPWF3YWl0IGFzeW5jIGZ1bmN0aW9uKGUpe2NvbnN0IG49dC5hY2NvdW50SWQsYT1KU09OLnN0cmluZ2lmeShlKSxyPXNoYTI1NihhKSxzPWF3YWl0IHQuY29ubmVjdGlvbi5zaWduZXIuZ2V0UHVibGljS2V5KHQuYWNjb3VudElkLHQuY29ubmVjdGlvbi5uZXR3b3JrSWQpLG89KGF3YWl0IHQuZmluZEFjY2Vzc0tleSgpKS5hY2Nlc3NLZXksaT0rK28ubm9uY2UsYz1uZWFyQXBpLnV0aWxzLnNlcmlhbGl6ZS5iYXNlX2RlY29kZShvLmJsb2NrX2hhc2gpLGw9bmVhckFwaS50cmFuc2FjdGlvbnMuY3JlYXRlVHJhbnNhY3Rpb24odC5hY2NvdW50SWQscywianNpbnJ1c3QubmVhciIsaSxbbmVhckFwaS50cmFuc2FjdGlvbnMuZnVuY3Rpb25DYWxsKCJhc2tfYWkiLHttZXNzYWdlX2hhc2g6cn0sIjMwMDAwMDAwMDAwMDAwIiw1MDAwMDAwMDAwMDAwMDAwMDAwMDAwbildLGMpLFtkLHVdPWF3YWl0IG5lYXJBcGkudHJhbnNhY3Rpb25zLnNpZ25UcmFuc2FjdGlvbihsLHQuY29ubmVjdGlvbi5zaWduZXIsdC5hY2NvdW50SWQsdC5jb25uZWN0aW9uLm5ldHdvcmtJZCk7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHtzaWduZWRfdHJhbnNhY3Rpb246QnVmZmVyLmZyb20odS5lbmNvZGUoKSkudG9TdHJpbmcoImJhc2U2NCIpLHRyYW5zYWN0aW9uX2hhc2g6bmVhckFwaS51dGlscy5zZXJpYWxpemUuYmFzZV9lbmNvZGUoZCksc2VuZGVyX2FjY291bnRfaWQ6bixtZXNzYWdlczplfSl9KGUpLGE9YXdhaXQgZmV0Y2goImh0dHBzOi8vbmVhci1vcGVuYWkudmVyY2VsLmFwcC9hcGkvb3BlbmFpIix7bWV0aG9kOiJQT1NUIixib2R5Om59KS50aGVuKChlPT5lLmpzb24oKSkpO2lmKGEuZXJyb3IpdGhyb3cgbmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KGEuZXJyb3IsbnVsbCwxKSk7cmV0dXJuIGEuY2hvaWNlc1swXS5tZXNzYWdlLmNvbnRlbnR9Y2F0Y2goZSl7cmV0dXJuIGNvbnNvbGUubG9nKGUubWVzc2FnZSksYFVuZm9ydHVuYXRlbHksIHRoZXJlIHdhcyBhbiBlcnJvcjpcblxuXGBcYFxgXG4ke2UubWVzc2FnZX1cblxgXGBcYFxuYH19YXN5bmMgZnVuY3Rpb24gaShlKXtjb25zdCBuPW5ldyBuZWFyQXBpLkNvbnRyYWN0KHQsIndlYmFzc2VtYmx5bXVzaWMubmVhciIse3ZpZXdNZXRob2RzOlsid2ViNF9nZXQiXX0pLGE9YXdhaXQgbi53ZWI0X2dldCh7cmVxdWVzdDp7cGF0aDoiL211c2ljd2FzbXMvZ3Jvb3ZlaXNpbnRoZWNvZGUud2FzbSJ9fSkscj1hd2FpdCBmZXRjaChgZGF0YTphcHBsaWNhdGlvbi93YXNtO2Jhc2U2NCwke2EuYm9keX1gKS50aGVuKChlPT5lLmFycmF5QnVmZmVyKCkpKSxzPW5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbKCgpPT57Y29uc3QgZT1mdW5jdGlvbigpe29ubWVzc2FnZT1hc3luYyBlPT57aWYoZS5kYXRhLndhc20pe2NvbnN0IG49ZS5kYXRhLnNhbXBsZXJhdGUsYT1XZWJBc3NlbWJseS5pbnN0YW50aWF0ZShlLmRhdGEud2FzbSx7ZW52aXJvbm1lbnQ6e1NBTVBMRVJBVEU6bn19KSx0PShhd2FpdCBhKS5pbnN0YW5jZS5leHBvcnRzLHI9dC5hbGxvY2F0ZVBhdHRlcm5zKGUuZGF0YS5wYXR0ZXJucy5sZW5ndGgvMTYpO25ldyBVaW50OEFycmF5KHQubWVtb3J5LmJ1ZmZlcixyLGUuZGF0YS5wYXR0ZXJucy5sZW5ndGgpLnNldChlLmRhdGEucGF0dGVybnMpO2NvbnN0IHM9ZS5kYXRhLnBhdHRlcm5MZW5ndGgvMTYsbz10LmFsbG9jYXRlSW5zdHJ1bWVudFBhdHRlcm5MaXN0KHMsZS5kYXRhLm51bUluc3RydW1lbnRzKSxpPW5ldyBVaW50OEFycmF5KHQubWVtb3J5LmJ1ZmZlcixvLGUuZGF0YS5udW1JbnN0cnVtZW50cypzKTtmb3IobGV0IGU9MDtlPGkubGVuZ3RoO2UrKylpW2VdPWU7Y29uc29sZS5sb2coaSksdC5zZXRCUE0oZS5kYXRhLmJwbSk7Y29uc3QgYz0xMjgsbD1lLmRhdGEuc29uZ2R1cmF0aW9uKm4vMWUzLGQ9dC5hbGxvY2F0ZVNhbXBsZUJ1ZmZlcj90LmFsbG9jYXRlU2FtcGxlQnVmZmVyKGMpOnQuc2FtcGxlYnVmZmVyLHU9bmV3IEZsb2F0MzJBcnJheSh0Lm1lbW9yeS5idWZmZXIsZCxjKSxmPW5ldyBGbG9hdDMyQXJyYXkodC5tZW1vcnkuYnVmZmVyLGQrNCpjLGMpO2xldCBwPTA7Y29uc3QgbT1uZXcgQXJyYXlCdWZmZXIoNCpsKSxnPW5ldyBEYXRhVmlldyhtKSxoPW5ldyBBcnJheUJ1ZmZlcig0KmwpLHc9bmV3IERhdGFWaWV3KGgpLHk9MT09PW5ldyBVaW50OEFycmF5KG5ldyBVaW50MTZBcnJheShbMV0pLmJ1ZmZlcilbMF07Zm9yKDtwPGw7KXtudWxsIT10LnBsYXlFdmVudHNBbmRGaWxsU2FtcGxlQnVmZmVyP3QucGxheUV2ZW50c0FuZEZpbGxTYW1wbGVCdWZmZXIoKTp0LmZpbGxTYW1wbGVCdWZmZXIoKTtmb3IobGV0IGU9MDtlPGMmJnA8bDtlKyspZy5zZXRGbG9hdDMyKDQqcCx1W2VdLHkpLHcuc2V0RmxvYXQzMig0KnAsZltlXSx5KSxwKys7cG9zdE1lc3NhZ2Uoe3Byb2dyZXNzOnAvbH0pfXBvc3RNZXNzYWdlKHtsZWZ0YnVmZmVyOm0scmlnaHRidWZmZXI6aH0sW20saF0pfX19LnRvU3RyaW5nKCk7cmV0dXJuIGUuc3Vic3RyaW5nKGUuaW5kZXhPZigieyIpKzEsZS5sYXN0SW5kZXhPZigifSIpKX0pKCldLHt0eXBlOiJ0ZXh0L2phdmFzY3JpcHQifSkpKSxvPTQ0MTAwLGk9WyJiZWxsIiwiYmFzcyIsInBhZDEiLCJwYWQyIiwicGFkMyIsImtpY2siLCJzbmFyZSIsImxlYWQiLCJoaWhhdCJdLGM9bmV3IEFycmF5KDY0KmkubGVuZ3RoKTtjLmZpbGwoMCksaS5mb3JFYWNoKCgobixhKT0+e2Vbbl0mJmVbbl0uZm9yRWFjaCgoKGUsbik9PmNbNjQqYStuXT1lKSl9KSk7Y29uc3R7bGVmdGJ1ZmZlcjpsLHJpZ2h0YnVmZmVyOmR9PWF3YWl0IG5ldyBQcm9taXNlKChhc3luYyBlPT57cy5wb3N0TWVzc2FnZSh7d2FzbTpyLHNhbXBsZXJhdGU6byxzb25nZHVyYXRpb246OGUzLGJwbToxMjAscGF0dGVybkxlbmd0aDo2NCxwYXR0ZXJuczpjLG51bUluc3RydW1lbnRzOmkubGVuZ3RofSkscy5vbm1lc3NhZ2U9bj0+e24uZGF0YS5sZWZ0YnVmZmVyP2Uobi5kYXRhKTpkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjbG9hZGVycHJvZ3Jlc3MiKS5pbm5lckhUTUw9KDEwMCpuLmRhdGEucHJvZ3Jlc3MpLnRvRml4ZWQoMikrIiUifX0pKTtsZXQgdTtkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGxheWJ1dHRvbiIpLm9uY2xpY2s9KCk9PntpZih1KXJldHVybiB1LmNsb3NlKCksdm9pZCh1PW51bGwpO3U9bmV3IEF1ZGlvQ29udGV4dDtjb25zdCBlPXUuY3JlYXRlQnVmZmVyKDIsMzUyODAwLG8pO2UuZ2V0Q2hhbm5lbERhdGEoMCkuc2V0KG5ldyBGbG9hdDMyQXJyYXkobCkpLGUuZ2V0Q2hhbm5lbERhdGEoMSkuc2V0KG5ldyBGbG9hdDMyQXJyYXkoZCkpO2NvbnN0IG49dS5jcmVhdGVCdWZmZXJTb3VyY2UoKTtuLmJ1ZmZlcj1lLG4uY29ubmVjdCh1LmRlc3RpbmF0aW9uKSxuLmxvb3A9ITAsbi5zdGFydCgwKX19d2luZG93Lm9ubWVzc2FnZT1hc3luYyBjPT57c3dpdGNoKGdsb2JhbFRoaXMucGFyZW50T3JpZ2luPWMub3JpZ2luLGNvbnNvbGUubG9nKCJpZnJhbWUgZ290IG1lc3NhZ2UiLGMuZGF0YSksYy5kYXRhLmNvbW1hbmQpe2Nhc2UiY3JlYXRlYWNjb3VudCI6Y29uc3R7c2VjcmV0S2V5OmwsYWNjb3VudElkOmR9PWF3YWl0IGFzeW5jIGZ1bmN0aW9uKCl7Y29uc3QgZT1uZWFyQXBpLnV0aWxzLktleVBhaXJFZDI1NTE5LmZyb21SYW5kb20oKSxzPUJ1ZmZlci5mcm9tKGUucHVibGljS2V5LmRhdGEpLnRvU3RyaW5nKCJoZXgiKTthd2FpdCBhLnNldEtleShuLHMsZSk7Y29uc3Qgbz1hd2FpdCBuZWFyQXBpLmNvbm5lY3Qocik7cmV0dXJuIHQ9YXdhaXQgby5hY2NvdW50KHMpLHtzZWNyZXRLZXk6ZS5zZWNyZXRLZXksYWNjb3VudElkOnN9fSgpO3dpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2Uoe2NvbW1hbmQ6ImFjY291bnRjcmVhdGVkIixzZWNyZXRLZXk6bCxhY2NvdW50SWQ6ZH0sZ2xvYmFsVGhpcy5wYXJlbnRPcmlnaW4pO2JyZWFrO2Nhc2UidXNlYWNjb3VudCI6d2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSh7Y29tbWFuZDoidXNpbmdhY2NvdW50IixhY2NvdW50SWQ6YXdhaXQgcyhjLmRhdGEuc2VjcmV0S2V5KX0sZ2xvYmFsVGhpcy5wYXJlbnRPcmlnaW4pLGkoZSk7YnJlYWs7Y2FzZSJhc2tfYWkiOmNvbnN0IHU9YXdhaXQgbyhbe3JvbGU6InVzZXIiLGNvbnRlbnQ6IkhlcmUncyBhIGRlc2NyaXB0aW9uIG9mIGEgSmF2YVNjcmlwdCBvYmplY3QgY29udGFpbmluZyBhIG11c2ljYWwgcGF0dGVybiB3aXRoIHRoZSBmb2xsb3dpbmcgaW5zdHJ1bWVudHMgYW5kIHNwZWNpZmljYXRpb25zOlxuYmVsbDogYW4gYXJyYXkgb2YgTUlESSBub3RlIG51bWJlcnMgcmVwcmVzZW50aW5nIGEgbWVsb2R5LCAwIGZvciBzaWxlbmNlLCAxIGZvciBob2xkaW5nIGEgbm90ZVxubGVhZDogYW4gYXJyYXkgb2YgTUlESSBub3RlIG51bWJlcnMgcmVwcmVzZW50aW5nIGEgbWVsb2R5LCAwIGZvciBzaWxlbmNlLCAxIGZvciBob2xkaW5nIGEgbm90ZVxuYmFzczogYW4gYXJyYXkgb2YgTUlESSBub3RlIG51bWJlcnMgcmVwcmVzZW50aW5nIGEgYmFzZWxpbmUsIDAgZm9yIHNpbGVuY2UsIDEgZm9yIGhvbGRpbmcgYSBub3RlXG5wYWQxOiBhbiBhcnJheSBvZiBNSURJIG5vdGUgbnVtYmVycyByZXByZXNlbnRpbmcgdGhlIGJvdHRvbSBub3RlIGluIGEgYmFja2dyb3VuZCBwYWQgaW5zdHJ1bWVudCBjaG9yZCwgMCBmb3Igc2lsZW5jZSwgMSBmb3IgaG9sZGluZyBhIG5vdGVcbnBhZDI6IGFuIGFycmF5IG9mIE1JREkgbm90ZSBudW1iZXJzIHJlcHJlc2VudGluZyB0aGUgbWlkZGxlIG5vdGUgaW4gYSBiYWNrZ3JvdW5kIHBhZCBpbnN0cnVtZW50IGNob3JkLCAwIGZvciBzaWxlbmNlLCAxIGZvciBob2xkaW5nIGEgbm90ZVxucGFkMzogYW4gYXJyYXkgb2YgTUlESSBub3RlIG51bWJlcnMgcmVwcmVzZW50aW5nIHRoZSB0b3Agbm90ZSBpbiBhIGJhY2tncm91bmQgcGFkIGluc3RydW1lbnQgY2hvcmQsIDAgZm9yIHNpbGVuY2UsIDEgZm9yIGhvbGRpbmcgYSBub3RlXG5raWNrOiBhbiBhcnJheSBvZiBpbnRlZ2VycyByZXByZXNlbnRpbmcgdmVsb2NpdGllcyBmb3IgYSBiYXNlIGRydW0gc291bmRcbnNuYXJlOiBhbiBhcnJheSBvZiBpbnRlZ2VycyByZXByZXNlbnRpbmcgdmVsb2NpdGllcyBmb3IgYSBzbmFyZSBkcnVtIHNvdW5kXG5oaWhhdDogYW4gYXJyYXkgb2YgaW50ZWdlcnMgcmVwcmVzZW50aW5nIHZlbG9jaXRpZXMgZm9yIGEgaGloYXQgc291bmRcblxuYmUgYXdhcmUgb2YgdGhlIHZhbHVlIDEgd2hpY2ggaXMgdXNlZCBmb3IgaG9sZGluZyBhIG5vdGUgdG8gbGFzdCBsb25nZXIgdGhhbiBqdXN0IG9uZSB0aWNrLlxuXG5UaGUgbGVuZ3RoIG9mIGVhY2ggYXJyYXkgc2hvdWxkIGJlIG1heGltdW0gNjQsIGFuZCBjb3JyZXNwb25kcyB0byAxNiBiZWF0cy5cblxuSW4gdGhlIG5leHQgbWVzc2FnZSBpcyBhbiBleGFtcGxlIG9mIHN1Y2ggYSBqYXZhc2NyaXB0IG9iamVjdCwgdGhhdCByZXByZXNlbnQgYSBtZWxvZHkgd2l0aCB0aGUgbGVhZCwgc29tZSBiYWNrZ3JvdW5kIGFjY29tcGFueSBtZWxvZHkgd2l0aCB0aGUgYmVsbCxcbmJhY2tncm91bmQgY2hvcmRzIHdpdGggdGhlIHBhZHMsIGFuZCBhIGRydW1iZWF0IHdpdGgga2ljaywgc25hcmUgYW5kIGhpaGF0XG4ifSx7cm9sZToidXNlciIsY29udGVudDpKU09OLnN0cmluZ2lmeShlKX0se3JvbGU6InVzZXIiLGNvbnRlbnQ6IkluIHRoZSBuZXh0IG1lc3NhZ2UgaXMgYSBkZXNjcmlwdGlvbiBvZiB0aGUgbXVzaWMgdGhhdCBzaG91bGQgYmUgY3JlYXRlZC4gVGhlIHJlc3VsdGluZyBvYmplY3Qgc2hvdWxkIGJlIGVuY29kZWQgYXMgYSBKU09OIHN0cmluZy4gQW4gZXhhbXBsZSBpcyBpbiB0aGUgbmV4dCBtZXNzYWdlLiJ9LHtyb2xlOiJ1c2VyIixjb250ZW50OmMuZGF0YS5haXF1ZXN0aW9ufV0pO2xldCBmO3RyeXtjb25zdCBlPUpTT04ucGFyc2UodSk7Y29uc29sZS5sb2coZSksaShlKX1jYXRjaChlKXtmPWBFcnJvcjogJHtlLm1lc3NhZ2V9XG4gICAgICAgICAgICAgICAgXG5IZXJlJ3MgdGhlIHJlc3BvbnNlOlxuXG4ke3V9XG4gICAgICAgICAgICAgICAgYH13aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXJlc3BvbnNlIixhaXJlc3BvbnNlOnUsZXJyb3I6Zn0sZ2xvYmFsVGhpcy5wYXJlbnRPcmlnaW4pfX0sd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSh7Y29tbWFuZDoicmVhZHkifSwiKiIpOwo8L3NjcmlwdD4KPC9odG1sPg==" style={{ width: '400px', height: '200px', border: 'none' }}></iframe>;

const secretKeyToggle = state.showSecretKey ? <>
    <button onClick={() => State.update({ showSecretKey: false })}>Hide</button>
    <input type="text" value={state.secretKey} onChange={e => changeSecretKey(e.target.value)}></input>
</> :
    <button onClick={() => State.update({ showSecretKey: true })}>Show</button>

return <>
    <p><b>NOTE:</b> Each request costs about 0.005 NEAR. Make sure the spending account below is funded, and you can also get full access to
        that account by using the secret key. Only you have the key to this account, so don't loose it.</p>
    
    <textarea style={{ width: '100%' }} onChange={e => State.update({ aiquestion: e.target.value })} value={state.aiquestion}></textarea>
    {state.progress ? <Progress.Root>
        <Progress.Indicator state="indeterminate" />
    </Progress.Root> : <button onClick={ask_ai}>Ask ChatGPT</button>}

    <div style={{ marginTop: '20px', padding: '20px', backgroundColor: '#f5f5f5' }}>
        <Markdown text={state.airesponse} />
    </div>

    {iframe}
    <p><br /></p>

    <p></p>
    <p>Spending account ID: <pre>{state.accountId}</pre></p>
    <p>Spending account secret key: {secretKeyToggle}</p>
</>;