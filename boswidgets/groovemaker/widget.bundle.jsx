const SECRET_KEY_STORAGE_KEY = 'secretKey';
Storage.privateGet(SECRET_KEY_STORAGE_KEY);

State.init({
    secretKey: null,
    airesponse: '',
    aiquestion: '',
    accountId: '',
    iframeMessage: null
});

function init_iframe() {
    const secretKey = Storage.privateGet(SECRET_KEY_STORAGE_KEY);

    State.update({
        secretKey,
        iframeMessage: secretKey ? {
            command: 'useaccount',
            secretKey: secretKey,
        } : {
            command: 'createaccount'
        }
    });
}

function ask_ai() {
    State.update({ iframeMessage: { command: 'ask_ai', aiquestion: state.aiquestion, ts: new Date().getTime() }, airesponse: '', progress: true });
}

function changeSecretKey(secretKey) {
    State.update({ secretKey });
    Storage.privateSet(SECRET_KEY_STORAGE_KEY, secretKey);
    init_iframe();
}

function handleMessage(msg) {
    switch (msg.command) {
        case 'accountcreated':
            Storage.privateSet(SECRET_KEY_STORAGE_KEY, msg.secretKey);
            State.update({ accountId: msg.accountId, secretKey: msg.secretKey });
            break;
        case 'airesponse':
            State.update({ airesponse: msg.airesponse, progress: false });
            break;
        case 'aiprogress':
            State.update({ progressText: msg.progressmessage, progress: true });
            break;
        case 'usingaccount':
            State.update({ accountId: msg.accountId });
            break;
        case 'ready':
            console.log('ready');
            init_iframe();
            break;
    }
}

const iframe = <iframe message={state.iframeMessage} onMessage={handleMessage} src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sPgogICAgPGhlYWQ+CiAgICAgICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiPgogICAgICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDwvaGVhZD4KICAgIDxib2R5PgogICAgICAgIDxidXR0b24gaWQ9InBsYXlidXR0b24iPnBsYXk8L2J1dHRvbj4KICAgICAgICA8ZGl2IGlkPSJsb2FkZXJwcm9ncmVzcyI+PC9kaXY+CiAgICA8L2JvZHk+CiAgICA8c2NyaXB0IHR5cGU9Im1vZHVsZSI+aW1wb3J0Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vbmVhci1hcGktanNAMi4xLjMvZGlzdC9uZWFyLWFwaS1qcy5taW4uanMiO2ltcG9ydCJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL2pzLXNoYTI1NkAwLjkuMC9zcmMvc2hhMjU2Lm1pbi5qcyI7Y29uc3QgZT17YmVsbDpbNTYsMCw2OCwwLDY2LDAsNjgsMCw2MSwwLDYzLDAsNTksMCw1NiwwLDU0LDAsNjYsMCw2NCwwLDY2LDAsNTksMCw2MSwwLDU4LDAsNTQsMCw2MSwwLDczLDAsNzEsMCw3MywwLDY2LDAsNjgsMCw1NCwwLDYxLDAsNTksMCw3MSwwLDcwLDAsNzEsMCw2NiwwLDcxLDAsNjYsMCw1OSwwXSxiYXNzOlszMiwxLDAsMCwzMiwxLDAsMCwzMCwxLDMyLDAsMzIsMCwzMiwzMCwzMCwxLDAsMCwzMCwxLDAsMCwyOCwxLDMwLDAsMzAsMCwzMCwyOCwzNywxLDAsMCwzNywxLDAsMCwzNSwxLDM3LDAsMzcsMCwzNywzNSwzNSwxLDAsMCwzNSwxLDAsMCwzMiwxLDM1LDAsMzUsMCwzNSwzMl0sa2ljazpbMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsMCwxMjAsMCwwLDAsMTIwLDAsMCwwLDEyMCwwLDAsNTAsMTIwLDAsMTAwLDAsMTIwLDAsMCwwXSxwYWQxOls2MywxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2MSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2NCwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSw2MywxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMV0scGFkMjpbNjgsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjYsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjgsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsNjYsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDFdLHBhZDM6WzcxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDcwLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDczLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDcxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxLDEsMSwxXSxsZWFkOlswLDAsNjMsMCw2OCwxLDEsMCw3MCwxLDcxLDEsMCwwLDAsMCwwLDAsNjEsMCw2NiwxLDEsMCw2OCwxLDcwLDEsMCwwLDAsMCwwLDAsNjgsMCw3MywxLDEsMCw3NSwxLDc2LDEsMCwwLDAsMCw3NSwxLDAsMCw3NSwxLDEsMCw3MywxLDc1LDEsNzEsMSw2NiwxXSxzbmFyZTpbMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDAsMCwxMDAsMCwwLDAsMCwwLDgwLDAsMTAwLDAsMCw1MF0saGloYXQ6WzMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDAsMzAsMCwzMCwwLDMwLDAsNjAsMCwzMCwwLDMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDAsMzAsMCwzMCwwLDMwLDAsNjAsMCwzMCwwLDMwLDAsMzAsMCw2MCwwLDMwLDAsMzAsMCwzMCwwLDYwLDQwLDYwLDMwXX0sbj0ibWFpbm5ldCIsYT1uZXcgbmVhckFwaS5rZXlTdG9yZXMuSW5NZW1vcnlLZXlTdG9yZTtsZXQgdDtjb25zdCByPXtrZXlTdG9yZTphLG5ldHdvcmtJZDpuLG5vZGVVcmw6YGh0dHBzOi8vcnBjLiR7bn0ubmVhci5vcmdgLHdhbGxldFVybDpgaHR0cHM6Ly93YWxsZXQuJHtufS5uZWFyLm9yZ2AsaGVscGVyVXJsOmBodHRwczovL2hlbHBlci4ke259Lm5lYXIub3JnYCxleHBsb3JlclVybDpgaHR0cHM6Ly9leHBsb3Jlci4ke259Lm5lYXIub3JnYH07YXN5bmMgZnVuY3Rpb24gcyhlKXtjb25zdCBzPW5lYXJBcGkudXRpbHMuS2V5UGFpci5mcm9tU3RyaW5nKGUpLG89QnVmZmVyLmZyb20ocy5wdWJsaWNLZXkuZGF0YSkudG9TdHJpbmcoImhleCIpO2F3YWl0IGEuc2V0S2V5KG4sbyxzKTtjb25zdCBpPWF3YWl0IG5lYXJBcGkuY29ubmVjdChyKTtyZXR1cm4gdD1hd2FpdCBpLmFjY291bnQobyksb31hc3luYyBmdW5jdGlvbiBvKGUpe3RyeXt3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXByb2dyZXNzIixwcm9ncmVzc21lc3NhZ2U6ImNyZWF0aW5nIHJlcXVlc3QifSxnbG9iYWxUaGlzLnBhcmVudE9yaWdpbik7Y29uc3Qgbj1hd2FpdCBhc3luYyBmdW5jdGlvbihlKXtjb25zdCBuPXQuYWNjb3VudElkLGE9SlNPTi5zdHJpbmdpZnkoZSkscj1zaGEyNTYoYSkscz1hd2FpdCB0LmNvbm5lY3Rpb24uc2lnbmVyLmdldFB1YmxpY0tleSh0LmFjY291bnRJZCx0LmNvbm5lY3Rpb24ubmV0d29ya0lkKSxvPShhd2FpdCB0LmZpbmRBY2Nlc3NLZXkoKSkuYWNjZXNzS2V5LGk9KytvLm5vbmNlLGM9bmVhckFwaS51dGlscy5zZXJpYWxpemUuYmFzZV9kZWNvZGUoby5ibG9ja19oYXNoKSxsPW5lYXJBcGkudHJhbnNhY3Rpb25zLmNyZWF0ZVRyYW5zYWN0aW9uKHQuYWNjb3VudElkLHMsImpzaW5ydXN0Lm5lYXIiLGksW25lYXJBcGkudHJhbnNhY3Rpb25zLmZ1bmN0aW9uQ2FsbCgiYXNrX2FpIix7bWVzc2FnZV9oYXNoOnJ9LCIzMDAwMDAwMDAwMDAwMCIsNTAwMDAwMDAwMDAwMDAwMDAwMDAwMG4pXSxjKSxbZCxwXT1hd2FpdCBuZWFyQXBpLnRyYW5zYWN0aW9ucy5zaWduVHJhbnNhY3Rpb24obCx0LmNvbm5lY3Rpb24uc2lnbmVyLHQuYWNjb3VudElkLHQuY29ubmVjdGlvbi5uZXR3b3JrSWQpO3JldHVybiBKU09OLnN0cmluZ2lmeSh7c2lnbmVkX3RyYW5zYWN0aW9uOkJ1ZmZlci5mcm9tKHAuZW5jb2RlKCkpLnRvU3RyaW5nKCJiYXNlNjQiKSx0cmFuc2FjdGlvbl9oYXNoOm5lYXJBcGkudXRpbHMuc2VyaWFsaXplLmJhc2VfZW5jb2RlKGQpLHNlbmRlcl9hY2NvdW50X2lkOm4sbWVzc2FnZXM6ZX0pfShlKTt3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXByb2dyZXNzIixwcm9ncmVzc21lc3NhZ2U6InNlbmRpbmcgcmVxdWVzdCJ9LGdsb2JhbFRoaXMucGFyZW50T3JpZ2luKTtjb25zdCBhPWF3YWl0IGZldGNoKCJodHRwczovL25lYXItb3BlbmFpLWdpdC1ib3N3aWRnZXQtZ3Jvb3ZlbWFrZXItcGV0ZXJzYWxvbW9uc2VuLnZlcmNlbC5hcHAvYXBpL29wZW5haXN0cmVhbSIse21ldGhvZDoiUE9TVCIsYm9keTpufSkscj1hLmJvZHkuZ2V0UmVhZGVyKCkscz1bXTtmb3IoOzspe2NvbnN0e2RvbmU6ZSx2YWx1ZTpufT1hd2FpdCByLnJlYWQoKTtpZihlKWJyZWFrO2NvbnN0IGE9KG5ldyBUZXh0RGVjb2RlcikuZGVjb2RlKG4pO3MucHVzaChhKSx3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJhaXByb2dyZXNzIixwcm9ncmVzc21lc3NhZ2U6YFJlY2VpdmVkIGNodW5rOiBcYCR7YX1cYGB9LGdsb2JhbFRoaXMucGFyZW50T3JpZ2luKX1yZXR1cm4gcy5qb2luKCIiKX1jYXRjaChlKXtyZXR1cm4gY29uc29sZS5sb2coZS5tZXNzYWdlKSxgVW5mb3J0dW5hdGVseSwgdGhlcmUgd2FzIGFuIGVycm9yOlxuXG5cYFxgXGBcbiR7ZS5tZXNzYWdlfVxuXGBcYFxgXG5gfX1hc3luYyBmdW5jdGlvbiBpKGUpe2NvbnN0IG49bmV3IG5lYXJBcGkuQ29udHJhY3QodCwid2ViYXNzZW1ibHltdXNpYy5uZWFyIix7dmlld01ldGhvZHM6WyJ3ZWI0X2dldCJdfSksYT1hd2FpdCBuLndlYjRfZ2V0KHtyZXF1ZXN0OntwYXRoOiIvbXVzaWN3YXNtcy9ncm9vdmVpc2ludGhlY29kZS53YXNtIn19KSxyPWF3YWl0IGZldGNoKGBkYXRhOmFwcGxpY2F0aW9uL3dhc207YmFzZTY0LCR7YS5ib2R5fWApLnRoZW4oKGU9PmUuYXJyYXlCdWZmZXIoKSkpLHM9bmV3IFdvcmtlcihVUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFsoKCk9Pntjb25zdCBlPWZ1bmN0aW9uKCl7b25tZXNzYWdlPWFzeW5jIGU9PntpZihlLmRhdGEud2FzbSl7Y29uc3Qgbj1lLmRhdGEuc2FtcGxlcmF0ZSxhPVdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGUuZGF0YS53YXNtLHtlbnZpcm9ubWVudDp7U0FNUExFUkFURTpufX0pLHQ9KGF3YWl0IGEpLmluc3RhbmNlLmV4cG9ydHMscj10LmFsbG9jYXRlUGF0dGVybnMoZS5kYXRhLnBhdHRlcm5zLmxlbmd0aC8xNik7bmV3IFVpbnQ4QXJyYXkodC5tZW1vcnkuYnVmZmVyLHIsZS5kYXRhLnBhdHRlcm5zLmxlbmd0aCkuc2V0KGUuZGF0YS5wYXR0ZXJucyk7Y29uc3Qgcz1lLmRhdGEucGF0dGVybkxlbmd0aC8xNixvPXQuYWxsb2NhdGVJbnN0cnVtZW50UGF0dGVybkxpc3QocyxlLmRhdGEubnVtSW5zdHJ1bWVudHMpLGk9bmV3IFVpbnQ4QXJyYXkodC5tZW1vcnkuYnVmZmVyLG8sZS5kYXRhLm51bUluc3RydW1lbnRzKnMpO2ZvcihsZXQgZT0wO2U8aS5sZW5ndGg7ZSsrKWlbZV09ZTtjb25zb2xlLmxvZyhpKSx0LnNldEJQTShlLmRhdGEuYnBtKTtjb25zdCBjPTEyOCxsPWUuZGF0YS5zb25nZHVyYXRpb24qbi8xZTMsZD10LmFsbG9jYXRlU2FtcGxlQnVmZmVyP3QuYWxsb2NhdGVTYW1wbGVCdWZmZXIoYyk6dC5zYW1wbGVidWZmZXIscD1uZXcgRmxvYXQzMkFycmF5KHQubWVtb3J5LmJ1ZmZlcixkLGMpLHU9bmV3IEZsb2F0MzJBcnJheSh0Lm1lbW9yeS5idWZmZXIsZCs0KmMsYyk7bGV0IGc9MDtjb25zdCBmPW5ldyBBcnJheUJ1ZmZlcig0KmwpLG09bmV3IERhdGFWaWV3KGYpLGg9bmV3IEFycmF5QnVmZmVyKDQqbCksdz1uZXcgRGF0YVZpZXcoaCksYj0xPT09bmV3IFVpbnQ4QXJyYXkobmV3IFVpbnQxNkFycmF5KFsxXSkuYnVmZmVyKVswXTtmb3IoO2c8bDspe251bGwhPXQucGxheUV2ZW50c0FuZEZpbGxTYW1wbGVCdWZmZXI/dC5wbGF5RXZlbnRzQW5kRmlsbFNhbXBsZUJ1ZmZlcigpOnQuZmlsbFNhbXBsZUJ1ZmZlcigpO2ZvcihsZXQgZT0wO2U8YyYmZzxsO2UrKyltLnNldEZsb2F0MzIoNCpnLHBbZV0sYiksdy5zZXRGbG9hdDMyKDQqZyx1W2VdLGIpLGcrKztwb3N0TWVzc2FnZSh7cHJvZ3Jlc3M6Zy9sfSl9cG9zdE1lc3NhZ2Uoe2xlZnRidWZmZXI6ZixyaWdodGJ1ZmZlcjpofSxbZixoXSl9fX0udG9TdHJpbmcoKTtyZXR1cm4gZS5zdWJzdHJpbmcoZS5pbmRleE9mKCJ7IikrMSxlLmxhc3RJbmRleE9mKCJ9IikpfSkoKV0se3R5cGU6InRleHQvamF2YXNjcmlwdCJ9KSkpLG89NDQxMDAsaT1bImJlbGwiLCJiYXNzIiwicGFkMSIsInBhZDIiLCJwYWQzIiwia2ljayIsInNuYXJlIiwibGVhZCIsImhpaGF0Il0sYz1uZXcgQXJyYXkoNjQqaS5sZW5ndGgpO2MuZmlsbCgwKSxpLmZvckVhY2goKChuLGEpPT57ZVtuXSYmZVtuXS5mb3JFYWNoKCgoZSxuKT0+Y1s2NCphK25dPWUpKX0pKTtjb25zdHtsZWZ0YnVmZmVyOmwscmlnaHRidWZmZXI6ZH09YXdhaXQgbmV3IFByb21pc2UoKGFzeW5jIGU9PntzLnBvc3RNZXNzYWdlKHt3YXNtOnIsc2FtcGxlcmF0ZTpvLHNvbmdkdXJhdGlvbjo4ZTMsYnBtOjEyMCxwYXR0ZXJuTGVuZ3RoOjY0LHBhdHRlcm5zOmMsbnVtSW5zdHJ1bWVudHM6aS5sZW5ndGh9KSxzLm9ubWVzc2FnZT1uPT57bi5kYXRhLmxlZnRidWZmZXI/ZShuLmRhdGEpOmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNsb2FkZXJwcm9ncmVzcyIpLmlubmVySFRNTD0oMTAwKm4uZGF0YS5wcm9ncmVzcykudG9GaXhlZCgyKSsiJSJ9fSkpO2xldCBwO2RvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwbGF5YnV0dG9uIikub25jbGljaz0oKT0+e2lmKHApcmV0dXJuIHAuY2xvc2UoKSx2b2lkKHA9bnVsbCk7cD1uZXcgQXVkaW9Db250ZXh0O2NvbnN0IGU9cC5jcmVhdGVCdWZmZXIoMiwzNTI4MDAsbyk7ZS5nZXRDaGFubmVsRGF0YSgwKS5zZXQobmV3IEZsb2F0MzJBcnJheShsKSksZS5nZXRDaGFubmVsRGF0YSgxKS5zZXQobmV3IEZsb2F0MzJBcnJheShkKSk7Y29uc3Qgbj1wLmNyZWF0ZUJ1ZmZlclNvdXJjZSgpO24uYnVmZmVyPWUsbi5jb25uZWN0KHAuZGVzdGluYXRpb24pLG4ubG9vcD0hMCxuLnN0YXJ0KDApfX13aW5kb3cub25tZXNzYWdlPWFzeW5jIGM9Pntzd2l0Y2goZ2xvYmFsVGhpcy5wYXJlbnRPcmlnaW49Yy5vcmlnaW4sY29uc29sZS5sb2coImlmcmFtZSBnb3QgbWVzc2FnZSIsYy5kYXRhKSxjLmRhdGEuY29tbWFuZCl7Y2FzZSJjcmVhdGVhY2NvdW50Ijpjb25zdHtzZWNyZXRLZXk6bCxhY2NvdW50SWQ6ZH09YXdhaXQgYXN5bmMgZnVuY3Rpb24oKXtjb25zdCBlPW5lYXJBcGkudXRpbHMuS2V5UGFpckVkMjU1MTkuZnJvbVJhbmRvbSgpLHM9QnVmZmVyLmZyb20oZS5wdWJsaWNLZXkuZGF0YSkudG9TdHJpbmcoImhleCIpO2F3YWl0IGEuc2V0S2V5KG4scyxlKTtjb25zdCBvPWF3YWl0IG5lYXJBcGkuY29ubmVjdChyKTtyZXR1cm4gdD1hd2FpdCBvLmFjY291bnQocykse3NlY3JldEtleTplLnNlY3JldEtleSxhY2NvdW50SWQ6c319KCk7d2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSh7Y29tbWFuZDoiYWNjb3VudGNyZWF0ZWQiLHNlY3JldEtleTpsLGFjY291bnRJZDpkfSxnbG9iYWxUaGlzLnBhcmVudE9yaWdpbik7YnJlYWs7Y2FzZSJ1c2VhY2NvdW50Ijp3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHtjb21tYW5kOiJ1c2luZ2FjY291bnQiLGFjY291bnRJZDphd2FpdCBzKGMuZGF0YS5zZWNyZXRLZXkpfSxnbG9iYWxUaGlzLnBhcmVudE9yaWdpbiksaShlKTticmVhaztjYXNlImFza19haSI6Y29uc3QgcD1hd2FpdCBvKFt7cm9sZToidXNlciIsY29udGVudDoiSGVyZSdzIGEgZGVzY3JpcHRpb24gb2YgYSBKYXZhU2NyaXB0IG9iamVjdCBjb250YWluaW5nIGEgbXVzaWNhbCBwYXR0ZXJuIHdpdGggdGhlIGZvbGxvd2luZyBpbnN0cnVtZW50cyBhbmQgc3BlY2lmaWNhdGlvbnM6XG5iZWxsOiBhbiBhcnJheSBvZiBNSURJIG5vdGUgbnVtYmVycyByZXByZXNlbnRpbmcgYSBtZWxvZHksIDAgZm9yIHNpbGVuY2UsIDEgZm9yIGhvbGRpbmcgYSBub3RlXG5sZWFkOiBhbiBhcnJheSBvZiBNSURJIG5vdGUgbnVtYmVycyByZXByZXNlbnRpbmcgYSBtZWxvZHksIDAgZm9yIHNpbGVuY2UsIDEgZm9yIGhvbGRpbmcgYSBub3RlXG5iYXNzOiBhbiBhcnJheSBvZiBNSURJIG5vdGUgbnVtYmVycyByZXByZXNlbnRpbmcgYSBiYXNlbGluZSwgMCBmb3Igc2lsZW5jZSwgMSBmb3IgaG9sZGluZyBhIG5vdGVcbnBhZDE6IGFuIGFycmF5IG9mIE1JREkgbm90ZSBudW1iZXJzIHJlcHJlc2VudGluZyB0aGUgYm90dG9tIG5vdGUgaW4gYSBiYWNrZ3JvdW5kIHBhZCBpbnN0cnVtZW50IGNob3JkLCAwIGZvciBzaWxlbmNlLCAxIGZvciBob2xkaW5nIGEgbm90ZVxucGFkMjogYW4gYXJyYXkgb2YgTUlESSBub3RlIG51bWJlcnMgcmVwcmVzZW50aW5nIHRoZSBtaWRkbGUgbm90ZSBpbiBhIGJhY2tncm91bmQgcGFkIGluc3RydW1lbnQgY2hvcmQsIDAgZm9yIHNpbGVuY2UsIDEgZm9yIGhvbGRpbmcgYSBub3RlXG5wYWQzOiBhbiBhcnJheSBvZiBNSURJIG5vdGUgbnVtYmVycyByZXByZXNlbnRpbmcgdGhlIHRvcCBub3RlIGluIGEgYmFja2dyb3VuZCBwYWQgaW5zdHJ1bWVudCBjaG9yZCwgMCBmb3Igc2lsZW5jZSwgMSBmb3IgaG9sZGluZyBhIG5vdGVcbmtpY2s6IGFuIGFycmF5IG9mIGludGVnZXJzIHJlcHJlc2VudGluZyB2ZWxvY2l0aWVzIGZvciBhIGJhc2UgZHJ1bSBzb3VuZFxuc25hcmU6IGFuIGFycmF5IG9mIGludGVnZXJzIHJlcHJlc2VudGluZyB2ZWxvY2l0aWVzIGZvciBhIHNuYXJlIGRydW0gc291bmRcbmhpaGF0OiBhbiBhcnJheSBvZiBpbnRlZ2VycyByZXByZXNlbnRpbmcgdmVsb2NpdGllcyBmb3IgYSBoaWhhdCBzb3VuZFxuXG5iZSBhd2FyZSBvZiB0aGUgdmFsdWUgMSB3aGljaCBpcyB1c2VkIGZvciBob2xkaW5nIGEgbm90ZSB0byBsYXN0IGxvbmdlciB0aGFuIGp1c3Qgb25lIHRpY2suXG5cblRoZSBsZW5ndGggb2YgZWFjaCBhcnJheSBzaG91bGQgYmUgbWF4aW11bSA2NCwgYW5kIGNvcnJlc3BvbmRzIHRvIDE2IGJlYXRzLlxuXG5JbiB0aGUgbmV4dCBtZXNzYWdlIGlzIGFuIGV4YW1wbGUgb2Ygc3VjaCBhIGphdmFzY3JpcHQgb2JqZWN0LCB0aGF0IHJlcHJlc2VudCBhIG1lbG9keSB3aXRoIHRoZSBsZWFkLCBzb21lIGJhY2tncm91bmQgYWNjb21wYW55IG1lbG9keSB3aXRoIHRoZSBiZWxsLFxuYmFja2dyb3VuZCBjaG9yZHMgd2l0aCB0aGUgcGFkcywgYW5kIGEgZHJ1bWJlYXQgd2l0aCBraWNrLCBzbmFyZSBhbmQgaGloYXRcbiJ9LHtyb2xlOiJ1c2VyIixjb250ZW50OkpTT04uc3RyaW5naWZ5KGUpfSx7cm9sZToidXNlciIsY29udGVudDoiSW4gdGhlIG5leHQgbWVzc2FnZSBpcyBhIGRlc2NyaXB0aW9uIG9mIHRoZSBtdXNpYyB0aGF0IHNob3VsZCBiZSBjcmVhdGVkLiBUaGUgcmVzdWx0aW5nIG9iamVjdCBzaG91bGQgYmUgZW5jb2RlZCBhcyBhIEpTT04gc3RyaW5nLiBBbiBleGFtcGxlIGlzIGluIHRoZSBuZXh0IG1lc3NhZ2UuIn0se3JvbGU6InVzZXIiLGNvbnRlbnQ6Yy5kYXRhLmFpcXVlc3Rpb259XSk7bGV0IHU7dHJ5e2koSlNPTi5wYXJzZShwKSl9Y2F0Y2goZSl7dT1gRXJyb3I6ICR7ZS5tZXNzYWdlfVxuICAgICAgICAgICAgICAgIFxuSGVyZSdzIHRoZSByZXNwb25zZTpcblxuJHtwfVxuICAgICAgICAgICAgICAgIGB9d2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSh7Y29tbWFuZDoiYWlyZXNwb25zZSIsYWlyZXNwb25zZTpwLGVycm9yOnV9LGdsb2JhbFRoaXMucGFyZW50T3JpZ2luKX19LHdpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2Uoe2NvbW1hbmQ6InJlYWR5In0sIioiKTsKPC9zY3JpcHQ+CjwvaHRtbD4=" style={{ width: '400px', height: '200px', border: 'none' }}></iframe>;


const ProgressWrapper = styled.div`
.progress-border {
    border: green solid 1px;
    height: 50px;
    width: 100%;
}

.progress-text {
    position: absolute;
    color: #666;
    text-align: center;
    width: 100%;
    height: 100%;
    font-size: 22px;
}

.progress-fill {
    background-color: rgba(0,255,0, 0.7);
    height: 50px;    
    width: 10%;
    animation-name: indeterminate;
    animation-duration: 2s;
    animation-iteration-count: infinite;
}

@keyframes indeterminate {
    0% { margin-left: 0%; width: 10%;}
    25% { width: 20%; }
    50% { margin-left: 90%; width: 10%; }
    75% { width: 20%; }
    100% { margin-left: 0%; width: 10%; }
}
`;

const progressIndicator = state.progress ? <ProgressWrapper><div id="main-progress-bar" class="progress-border">
    <div class="progress-text">{state.progressText}</div>
    <div class="progress-fill"></div>
</div></ProgressWrapper> : <button onClick={ask_ai}>Ask ChatGPT</button>;

const responseArea = <div style={{ marginTop: '20px', padding: '20px', backgroundColor: '#f5f5f5' }}>
    <Markdown text={state.airesponse} />
</div>;

const secretKeyToggle = state.showSecretKey ? <>
    <button onClick={() => State.update({ showSecretKey: false })}>Hide</button>
    <input type="text" value={state.secretKey} onChange={e => changeSecretKey(e.target.value)}></input>
</> :
    <button onClick={() => State.update({ showSecretKey: true })}>Show</button>

return <>
    <p><b>NOTE:</b> Each request costs about 0.005 NEAR. Make sure the spending account below is funded, and you can also get full access to
        that account by using the secret key. Only you have the key to this account, so don't loose it.</p>

    <textarea style={{ width: '100%' }} onChange={e => State.update({ aiquestion: e.target.value })} value={state.aiquestion}></textarea>
    {progressIndicator}
    {responseArea}

    {iframe}


    <p><br /></p>

    <p></p>
    <p>Spending account ID: <pre>{state.accountId}</pre></p>
    <p>Spending account secret key: {secretKeyToggle}</p>
</>;